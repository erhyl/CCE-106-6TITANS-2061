<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Schedule - Coach Dashboard</title>
  <link rel="stylesheet" href="assets/css/styles-base.css">
  <link rel="stylesheet" href="assets/css/admin.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      background: #0a0a0a;
      color: #fff;
    }
    
    /* Dashboard and Logout Button Styling */
    .user-dropdown a[href="coach-dashboard.html"] {
      color: #9c27b0 !important;
      font-weight: 600;
      border-radius: 20px !important;
      margin: 2px 8px !important;
      background: rgba(156, 39, 176, 0.1) !important;
      border: 2px solid transparent !important;
    }

    .user-dropdown a[href="coach-dashboard.html"]:hover {
      color: #ba68c8 !important;
      background: rgba(156, 39, 176, 0.25) !important;
      border-color: #9c27b0 !important;
      transform: scale(1.05) !important;
    }

    .user-dropdown a[id="coachLogoutBtn"] {
      color: #2196f3 !important;
      font-weight: 600;
      border-radius: 20px !important;
      margin: 2px 8px !important;
      background: rgba(33, 150, 243, 0.1) !important;
      border: 2px solid transparent !important;
    }

    .user-dropdown a[id="coachLogoutBtn"]:hover {
      color: #64b5f6 !important;
      background: rgba(33, 150, 243, 0.25) !important;
      border-color: #2196f3 !important;
      transform: scale(1.05) !important;
    }

    .schedule-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 120px 2rem 4rem;
    }

    .page-header {
      margin-bottom: 2rem;
    }

    .page-header h1 {
      color: #ffd700;
      margin-bottom: 0.5rem;
    }

    .calendar-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding: 1rem;
      background: #1a1a1a;
      border-radius: 8px;
    }

    .calendar-nav {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .calendar-nav button {
      padding: 0.5rem 1rem;
      background: #ffd700;
      color: #000;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }

    .calendar-nav button:hover {
      background: #ffed4e;
    }

    .current-month {
      font-size: 1.5rem;
      font-weight: 600;
      color: #ffd700;
    }

    .view-toggle {
      display: flex;
      gap: 0.5rem;
    }

    .view-toggle button {
      padding: 0.5rem 1rem;
      background: #2a2a2a;
      color: #fff;
      border: 1px solid #333;
      border-radius: 6px;
      cursor: pointer;
    }

    .view-toggle button.active {
      background: #ffd700;
      color: #000;
      border-color: #ffd700;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: #333;
      border: 1px solid #333;
      border-radius: 8px;
      overflow: hidden;
    }

    .calendar-day-header {
      background: #1a1a1a;
      padding: 1rem;
      text-align: center;
      font-weight: 600;
      color: #ffd700;
    }

    .calendar-day {
      background: #0a0a0a;
      min-height: 120px;
      padding: 0.5rem;
      position: relative;
      cursor: pointer;
      transition: background 0.3s;
    }

    .calendar-day:hover {
      background: #1a1a1a;
    }

    .calendar-day.other-month {
      opacity: 0.3;
    }

    .calendar-day.today {
      background: #1a2a1a;
      border: 2px solid #ffd700;
    }

    .day-number {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #fff;
    }

    .day-sessions {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .session-pill {
      padding: 0.25rem 0.5rem;
      background: #4caf50;
      border-radius: 4px;
      font-size: 0.75rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .session-pill.pending {
      background: #ff9800;
    }

    .session-pill.completed {
      background: #2196F3;
    }

    .timeline-view {
      display: none;
    }

    .timeline-view.active {
      display: block;
    }

    .timeline-day {
      margin-bottom: 2rem;
    }

    .timeline-date {
      font-size: 1.2rem;
      font-weight: 600;
      color: #ffd700;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #333;
    }

    .timeline-sessions {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .timeline-session {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      background: #1a1a1a;
      border-left: 4px solid #ffd700;
      border-radius: 6px;
    }

    .session-time {
      min-width: 100px;
      color: #ffd700;
      font-weight: 600;
    }

    .session-details {
      flex: 1;
    }

    .session-details h4 {
      margin-bottom: 0.5rem;
      color: #fff;
    }

    .session-details p {
      color: #888;
      font-size: 0.9rem;
    }

    .session-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .btn-sm {
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.3s;
    }

    .btn-complete {
      background: #4caf50;
      color: #fff;
    }

    .btn-cancel {
      background: #f44336;
      color: #fff;
    }

    .btn-view {
      background: #2196F3;
      color: #fff;
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .status-confirmed {
      background: #4caf50;
      color: #fff;
    }

    .status-pending {
      background: #ff9800;
      color: #000;
    }

    .status-completed {
      background: #2196F3;
      color: #fff;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.8);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: #1a1a1a;
      padding: 2rem;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-header h2 {
      color: #ffd700;
    }

    .close-modal {
      background: none;
      border: none;
      color: #fff;
      font-size: 2rem;
      cursor: pointer;
    }

    .detail-row {
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #333;
    }

    .detail-label {
      color: #ffd700;
      font-weight: 600;
    }

    .detail-value {
      color: #fff;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-logo">
        <img src="images/image 66.png" alt="6Titans Logo" class="logo-icon">
        <img src="images/image 67.png" alt="6Titans" class="logo-text">
      </div>
      <ul class="nav-menu">
        <li class="nav-item"><a href="coach-dashboard.html" class="nav-link">Dashboard</a></li>
        <li class="nav-item"><a href="coach-schedule.html" class="nav-link active">Schedule</a></li>
        <li class="nav-item"><a href="coach-bookings.html" class="nav-link">Bookings</a></li>
        <li class="nav-item"><a href="coach-availability.html" class="nav-link">Availability</a></li>
      </ul>
      
        <div class="user-dropdown" id="coachDropdown">
          <a href="coach-dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
          <a href="#" id="coachLogoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Schedule Content -->
  <div class="schedule-container">
    <div class="page-header">
      <h1><i class="fas fa-calendar-alt"></i> My Schedule</h1>
      <p style="color: #888;">View and manage your coaching sessions</p>
    </div>

    <!-- Calendar Controls -->
    <div class="calendar-controls">
      <div class="calendar-nav">
        <button id="prevMonth"><i class="fas fa-chevron-left"></i></button>
        <span class="current-month" id="currentMonth">January 2024</span>
        <button id="nextMonth"><i class="fas fa-chevron-right"></i></button>
        <button id="todayBtn">Today</button>
      </div>
      <div class="view-toggle">
        <button class="active" data-view="calendar"><i class="fas fa-calendar"></i> Calendar</button>
        <button data-view="timeline"><i class="fas fa-list"></i> Timeline</button>
      </div>
    </div>

    <!-- Calendar View -->
    <div id="calendarView" class="calendar-view active">
      <div class="calendar-grid" id="calendarGrid">
        <!-- Calendar days will be dynamically generated -->
      </div>
    </div>

    <!-- Timeline View -->
    <div id="timelineView" class="timeline-view">
      <div id="timelineContent">
        <p style="text-align: center; color: #888;">Loading timeline...</p>
      </div>
    </div>
  </div>

  <!-- Session Details Modal -->
  <div class="modal" id="sessionModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Session Details</h2>
        <button class="close-modal" onclick="closeModal()">&times;</button>
      </div>
      <div id="sessionDetails"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getDatabase, ref, get, update, onValue } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2YE5Cn0gbiuQ5sq8lErotl01itq5-hYk",
      authDomain: "titans-8d454.firebaseapp.com",
      projectId: "titans-8d454",
      storageBucket: "titans-8d454.firebasestorage.app",
      messagingSenderId: "537648978979",
      appId: "1:537648978979:web:30eb90af77c7569b7be596",
      measurementId: "G-W1D2R0Q1L1",
      databaseURL: "https://titans-8d454-default-rtdb.firebaseio.com"
    };

    const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
    const auth = getAuth(app);
    const rtdb = getDatabase(app);
    const db = getFirestore(app);

    let coachName = '';
    let allBookings = [];
    let currentDate = new Date();
    let currentView = 'calendar';

    // Convert time to AM/PM format
    function formatTime(timeStr) {
      if (!timeStr) return '';
      
      // Handle different time formats
      if (timeStr.includes(':')) {
        const [hours, minutes] = timeStr.split(':');
        const hour = parseInt(hours);
        const min = minutes || '00';
        
        if (hour === 0) return `12:${min} AM`;
        if (hour < 12) return `${hour}:${min} AM`;
        if (hour === 12) return `12:${min} PM`;
        return `${hour - 12}:${min} PM`;
      }
      
      // If it's just a number (like "11")
      const hour = parseInt(timeStr);
      if (!isNaN(hour)) {
        if (hour === 0) return '12:00 AM';
        if (hour < 12) return `${hour}:00 AM`;
        if (hour === 12) return '12:00 PM';
        return `${hour - 12}:00 PM`;
      }
      
      return timeStr; // Return as-is if can't parse
    }

    // Get coach info
    async function getCoachInfo(uid) {
      try {
        const userDoc = await getDoc(doc(db, "users", uid));
        if (userDoc.exists()) {
          const userData = userDoc.data();
          return `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
        }
      } catch (error) {
        console.error('Error getting coach info:', error);
      }
      return '';
    }

    // Load bookings
    async function loadBookings() {
      try {
        const snapshot = await get(ref(rtdb, 'coachBookings'));
        const bookings = snapshot.val();

        if (!bookings) {
          allBookings = [];
          renderCalendar();
          return;
        }

        // Check if current coach is trusted
        let isTrustedCoach = false;
        try {
          const coachProfilesSnapshot = await get(ref(rtdb, 'coachProfiles'));
          if (coachProfilesSnapshot.exists()) {
            const coachProfiles = coachProfilesSnapshot.val();
            const coachProfile = Object.values(coachProfiles).find(profile => 
              profile.coachUid === currentUser.uid || profile.coachId === currentUser.uid
            );
            isTrustedCoach = coachProfile?.trustedCoach || false;
            console.log('Coach Schedule - Is trusted coach:', isTrustedCoach);
          }
        } catch (error) {
          console.error('Error checking trusted coach status:', error);
        }

        allBookings = Object.entries(bookings)
          .map(([id, booking]) => ({ id, ...booking }))
          .filter(booking => {
            // Match by coach name
            const matches = booking.coachName === coachName;
            
            // Show bookings based on trust status
            let shouldShow = false;
            if (isTrustedCoach) {
              // Trusted coaches see: pending_coach_approval, confirmed, completed
              shouldShow = booking.status === 'pending_coach_approval' || 
                          booking.status === 'confirmed' || 
                          booking.status === 'completed';
            } else {
              // Non-trusted coaches see: confirmed, completed (admin-approved only)
              shouldShow = booking.status === 'confirmed' || 
                          booking.status === 'completed';
            }
            
            console.log(`Coach Schedule - Booking ${booking.id}:`, {
              coachName: booking.coachName,
              currentCoachName: coachName,
              matches: matches,
              status: booking.status,
              isTrustedCoach: isTrustedCoach,
              shouldShow: shouldShow,
              finalResult: matches && shouldShow
            });
            
            return matches && shouldShow;
          })
          .sort((a, b) => new Date(a.preferredDate) - new Date(b.preferredDate));

        renderCalendar();
        renderTimeline();
      } catch (error) {
        console.error('Error loading bookings:', error);
      }
    }

    // Render calendar
    function renderCalendar() {
      const grid = document.getElementById('calendarGrid');
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      // Update header
      document.getElementById('currentMonth').textContent = 
        currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

      // Clear grid
      grid.innerHTML = '';

      // Day headers
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      days.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day-header';
        header.textContent = day;
        grid.appendChild(header);
      });

      // Get first day of month
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const daysInPrevMonth = new Date(year, month, 0).getDate();

      // Previous month days
      for (let i = firstDay - 1; i >= 0; i--) {
        const day = createDayCell(daysInPrevMonth - i, true);
        grid.appendChild(day);
      }

      // Current month days
      for (let i = 1; i <= daysInMonth; i++) {
        const day = createDayCell(i, false);
        grid.appendChild(day);
      }

      // Next month days
      const remainingDays = 42 - (firstDay + daysInMonth);
      for (let i = 1; i <= remainingDays; i++) {
        const day = createDayCell(i, true);
        grid.appendChild(day);
      }
    }

    function createDayCell(dayNum, otherMonth) {
      const cell = document.createElement('div');
      cell.className = 'calendar-day';
      if (otherMonth) cell.classList.add('other-month');

      const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
      const today = new Date().toISOString().split('T')[0];
      
      if (dateStr === today && !otherMonth) {
        cell.classList.add('today');
      }

      cell.innerHTML = `
        <div class="day-number">${dayNum}</div>
        <div class="day-sessions" id="day-${dateStr}"></div>
      `;

      // Add sessions for this day
      if (!otherMonth) {
        const daySessions = allBookings.filter(b => b.preferredDate === dateStr);
        const sessionsContainer = cell.querySelector('.day-sessions');
        
        daySessions.forEach(session => {
          const pill = document.createElement('div');
          pill.className = `session-pill ${session.status}`;
          pill.textContent = `${formatTime(session.preferredTime)} ${session.memberName}`;
          pill.onclick = (e) => {
            e.stopPropagation();
            showSessionDetails(session);
          };
          sessionsContainer.appendChild(pill);
        });
      }

      return cell;
    }

    // Render timeline
    function renderTimeline() {
      const container = document.getElementById('timelineContent');
      
      if (allBookings.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #888;">No scheduled sessions</p>';
        return;
      }

      // Group by date
      const grouped = {};
      allBookings.forEach(booking => {
        if (!grouped[booking.preferredDate]) {
          grouped[booking.preferredDate] = [];
        }
        grouped[booking.preferredDate].push(booking);
      });

      let html = '';
      Object.entries(grouped).forEach(([date, sessions]) => {
        const dateObj = new Date(date);
        const dateStr = dateObj.toLocaleDateString('en-US', { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });

        html += `
          <div class="timeline-day">
            <div class="timeline-date">${dateStr}</div>
            <div class="timeline-sessions">
              ${sessions.map(session => `
                <div class="timeline-session">
                  <div class="session-time">${formatTime(session.preferredTime)}</div>
                  <div class="session-details">
                    <h4>${session.memberName} - ${session.sessionType}</h4>
                    <p>${session.goals || 'No specific goals'}</p>
                  </div>
                  <div class="session-actions">
                    <span class="status-badge status-${session.status}">${session.status.toUpperCase()}</span>
                    ${session.status === 'confirmed' ? `
                      <button class="btn-sm btn-complete" onclick="completeSession('${session.id}')">
                        <i class="fas fa-check"></i>
                      </button>
                    ` : ''}
                    <button class="btn-sm btn-view" onclick="showSessionDetails(${JSON.stringify(session).replace(/"/g, '&quot;')})">
                      <i class="fas fa-eye"></i>
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Show session details
    window.showSessionDetails = function(session) {
      const modal = document.getElementById('sessionModal');
      const details = document.getElementById('sessionDetails');

      details.innerHTML = `
        <div class="detail-row">
          <span class="detail-label">Client:</span>
          <span class="detail-value">${session.memberName}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Email:</span>
          <span class="detail-value">${session.memberEmail}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Phone:</span>
          <span class="detail-value">${session.memberPhone || 'N/A'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Date:</span>
          <span class="detail-value">${new Date(session.preferredDate).toLocaleDateString()}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Time:</span>
          <span class="detail-value">${formatTime(session.preferredTime)}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Session Type:</span>
          <span class="detail-value">${session.sessionType}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Status:</span>
          <span class="detail-value"><span class="status-badge status-${session.status}">${session.status.toUpperCase()}</span></span>
        </div>
        ${session.goals ? `
          <div style="margin-top: 1rem; padding: 1rem; background: #222; border-radius: 6px;">
            <strong style="color: #ffd700;">Goals:</strong>
            <p style="margin-top: 0.5rem;">${session.goals}</p>
          </div>
        ` : ''}
      `;

      modal.classList.add('active');
    };

    window.closeModal = function() {
      document.getElementById('sessionModal').classList.remove('active');
    };

    // Complete session
    window.completeSession = async function(id) {
      if (!confirm('Mark this session as completed?')) return;
      
      try {
        await update(ref(rtdb, `coachBookings/${id}`), {
          status: 'completed',
          completedAt: Date.now()
        });
        alert('Session marked as completed!');
        loadBookings();
      } catch (error) {
        alert('Failed to update session: ' + error.message);
      }
    };

    // Navigation
    document.getElementById('prevMonth').addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    });

    document.getElementById('nextMonth').addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    });

    document.getElementById('todayBtn').addEventListener('click', () => {
      currentDate = new Date();
      renderCalendar();
    });

    // View toggle
    document.querySelectorAll('.view-toggle button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.view-toggle button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const view = btn.dataset.view;
        document.getElementById('calendarView').classList.toggle('active', view === 'calendar');
        document.getElementById('timelineView').classList.toggle('active', view === 'timeline');
      });
    });

    // Logout
    document.getElementById('coachLogoutBtn').addEventListener('click', async () => {
      try {
        await signOut(auth);
        window.location.href = 'coach-login.html';
      } catch (error) {
        alert('Logout failed: ' + error.message);
      }
    });

    // Initialize
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'coach-login.html';
        return;
      }

      coachName = await getCoachInfo(user.uid);
      loadBookings();

      // Real-time updates
      onValue(ref(rtdb, 'coachBookings'), () => {
        loadBookings();
      });
    });
  </script>
  <script src="script.js"></script>
</body>
</html>

