<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coach Bookings - 6Titans Admin</title>
  <link rel="stylesheet" href="assets/css/styles-base.css">
  <link rel="stylesheet" href="assets/css/admin.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    .filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .filter-group label {
      color: #888;
      font-size: 0.9rem;
      font-weight: 600;
    }
    .filter-group select, .filter-group input {
      padding: 0.5rem;
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 6px;
      color: #fff;
    }
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-box {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }
    .stat-box h3 {
      color: #ffd700;
      font-size: 2rem;
      margin: 0 0 0.5rem 0;
    }
    .stat-box p {
      color: #888;
      margin: 0;
    }
    .bookings-table {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 12px;
      overflow: hidden;
    }
    .table-header {
      background: #0a0a0a;
      padding: 1rem;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .table-header h2 {
      color: #ffd700;
      margin: 0;
    }
    .btn-export {
      background: #4CAF50;
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    thead {
      background: #0a0a0a;
    }
    th {
      color: #ffd700;
      padding: 1rem;
      text-align: left;
      font-weight: 700;
      border-bottom: 2px solid #333;
    }
    td {
      color: #ccc;
      padding: 1rem;
      border-bottom: 1px solid #222;
    }
    tr:hover {
      background: #222;
    }
    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .status-pending {
      background: #ff9800;
      color: #000;
    }
    .status-pending_admin_approval {
      background: #ff6b35;
      color: #fff;
    }
    .status-pending_coach_approval {
      background: #ffa726;
      color: #000;
    }
    .status-confirmed {
      background: #4CAF50;
      color: #fff;
    }
    .status-completed {
      background: #2196F3;
      color: #fff;
    }
    .status-cancelled {
      background: #f44336;
      color: #fff;
    }
    .action-btns {
      display: flex;
      gap: 0.5rem;
    }
    .btn-sm {
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.3s;
    }
    .btn-view {
      background: #2196F3;
      color: white;
    }
    .btn-confirm {
      background: #4CAF50;
      color: white;
    }
    .btn-cancel {
      background: #f44336;
      color: white;
    }
    .btn-delete {
      background: #666;
      color: white;
    }
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #888;
    }
    .empty-state i {
      font-size: 3rem;
      color: #333;
      margin-bottom: 1rem;
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: #1a1a1a;
      border: 2px solid #ffd700;
      border-radius: 16px;
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #333;
    }
    .modal-header h2 {
      color: #ffd700;
      margin: 0;
    }
    .close-modal {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.5rem;
      cursor: pointer;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid #222;
    }
    .detail-label {
      color: #888;
      font-weight: 600;
    }
    .detail-value {
      color: #fff;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-logo">
        <img src="images/image 66.png" alt="6Titans Logo" class="logo-icon" />
        <img src="images/image 67.png" alt="6Titans" class="logo-text" />
      </div>
      <ul class="nav-menu">
        <li class="nav-item"><a href="admin.html" class="nav-link">Dashboard</a></li>
        <li class="nav-item"><a href="admin-users.html" class="nav-link">Users</a></li>
        <li class="nav-item"><a href="admin-coaches.html" class="nav-link">Coaches</a></li>
        <li class="nav-item"><a href="admin-classes.html" class="nav-link ">Classes</a></li>    
        <li class="nav-item"><a href="admin-coach-profiles.html" class="nav-link">Coach Profiles</a></li>
        
        <li class="nav-item"><a href="admin-bookings.html" class="nav-link active">Bookings</a></li>
      </ul>
    </div>
  </nav>

  <section class="admin-dashboard" style="padding: 120px 0 80px;">
    <div class="container">
      <div class="page-header">
        <div>
          <h1 style="color: #ffd700;">Coach Bookings</h1>
          <p style="color: #888;">View and manage all coach session bookings</p>
        </div>
        <button class="btn-export" id="exportBtn">
          <i class="fas fa-download"></i> Export to CSV
        </button>
      </div>

      <!-- Statistics -->
      <div class="stats-row">
        <div class="stat-box">
          <h3 id="totalBookings">0</h3>
          <p>Total Bookings</p>
        </div>
        <div class="stat-box">
          <h3 id="pendingBookings">0</h3>
          <p>Pending</p>
        </div>
        <div class="stat-box">
          <h3 id="confirmedBookings">0</h3>
          <p>Confirmed</p>
        </div>
        <div class="stat-box">
          <h3 id="todayBookings">0</h3>
          <p>Today</p>
        </div>
      </div>

      <!-- Filters -->
      <div class="filters">
        <div class="filter-group">
          <label>Status</label>
          <select id="filterStatus">
            <option value="">All Statuses</option>
            <option value="pending_admin_approval">⏳ Pending Admin Approval</option>
            <option value="pending_coach_approval">⏳ Pending Coach Approval</option>
            <option value="confirmed">✅ Confirmed</option>
            <option value="completed">✔️ Completed</option>
            <option value="cancelled">❌ Cancelled</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Coach</label>
          <select id="filterCoach">
            <option value="">All Coaches</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Date From</label>
          <input type="date" id="filterDateFrom">
        </div>
        <div class="filter-group">
          <label>Date To</label>
          <input type="date" id="filterDateTo">
        </div>
        <div class="filter-group">
          <label>&nbsp;</label>
          <button class="btn-export" id="clearFilters" style="background: #666;">
            <i class="fas fa-times"></i> Clear Filters
          </button>
        </div>
      </div>

      <!-- Bookings Table -->
      <div class="bookings-table">
        <div class="table-header">
          <h2>All Bookings</h2>
          <button class="btn-export" id="refreshBtn">
            <i class="fas fa-sync"></i> Refresh
          </button>
        </div>
        <div id="bookingsTableContainer">
          <p style="color: #888; text-align: center; padding: 2rem;">Loading bookings...</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Booking Details Modal -->
  <div class="modal" id="detailsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Booking Details</h2>
        <button class="close-modal" onclick="closeModal()">&times;</button>
      </div>
      <div id="bookingDetails"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getDatabase, ref, get, update, remove, push, set } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { requireAdmin } from "./role-guard.js";

    // Protect this page
    requireAdmin();

    const firebaseConfig = {
      apiKey: "AIzaSyC2YE5Cn0gbiuQ5sq8lErotl01itq5-hYk",
      authDomain: "titans-8d454.firebaseapp.com",
      projectId: "titans-8d454",
      storageBucket: "titans-8d454.firebasestorage.app",
      messagingSenderId: "537648978979",
      appId: "1:537648978979:web:30eb90af77c7569b7be596",
      measurementId: "G-W1D2R0Q1L1",
      databaseURL: "https://titans-8d454-default-rtdb.firebaseio.com"
    };

    // Use a unique app name to avoid conflicts with role-guard.js initialization
    const app = initializeApp(firebaseConfig, 'admin-bookings-app');
    const db = getDatabase(app);
    const auth = getAuth(app);

    let allBookings = [];
    let filteredBookings = [];

    // Load bookings
    async function loadBookings() {
      try {
        const snapshot = await get(ref(db, 'coachBookings'));
        const bookings = snapshot.val();

        if (!bookings) {
          allBookings = [];
          updateStats();
          displayBookings([]);
          return;
        }

        // Convert to array and add IDs
        allBookings = Object.entries(bookings).map(([id, booking]) => ({
          id,
          ...booking
        }));

        // Sort by date (newest first)
        allBookings.sort((a, b) => new Date(b.bookingDate || b.preferredDate) - new Date(a.bookingDate || a.preferredDate));

        // Load coaches for filter
        await loadCoachesFilter();

        // Initial display
        applyFilters();
      } catch (error) {
        console.error('Error loading bookings:', error);
        document.getElementById('bookingsTableContainer').innerHTML = 
          '<p style="color: #f44336; text-align: center; padding: 2rem;">Failed to load bookings. Please try again.</p>';
      }
    }

    // Load coaches for filter dropdown
    async function loadCoachesFilter() {
      try {
        const snapshot = await get(ref(db, 'coachProfiles'));
        const coaches = snapshot.val();
        const filterCoach = document.getElementById('filterCoach');
        
        if (coaches) {
          const coachOptions = Object.values(coaches).map(coach => 
            `<option value="${coach.name}">${coach.name}</option>`
          ).join('');
          filterCoach.innerHTML = '<option value="">All Coaches</option>' + coachOptions;
        }
      } catch (error) {
        console.error('Error loading coaches for filter:', error);
      }
    }

    // Apply filters
    function applyFilters() {
      const status = document.getElementById('filterStatus').value;
      const coach = document.getElementById('filterCoach').value;
      const dateFrom = document.getElementById('filterDateFrom').value;
      const dateTo = document.getElementById('filterDateTo').value;

      filteredBookings = allBookings.filter(booking => {
        if (status && booking.status !== status) return false;
        if (coach && booking.coachName !== coach) return false;
        if (dateFrom && booking.preferredDate < dateFrom) return false;
        if (dateTo && booking.preferredDate > dateTo) return false;
        return true;
      });

      updateStats();
      displayBookings(filteredBookings);
    }

    // Update statistics
    function updateStats() {
      const today = new Date().toISOString().split('T')[0];
      
      document.getElementById('totalBookings').textContent = allBookings.length;
      
      // Count pending (both admin and coach approval)
      document.getElementById('pendingBookings').textContent = 
        allBookings.filter(b => 
          b.status === 'pending_admin_approval' || 
          b.status === 'pending_coach_approval' || 
          b.status === 'pending' || 
          !b.status
        ).length;
      
      document.getElementById('confirmedBookings').textContent = 
        allBookings.filter(b => b.status === 'confirmed').length;
      
      document.getElementById('todayBookings').textContent = 
        allBookings.filter(b => b.preferredDate === today).length;
    }

    // Format status for display
    function formatStatus(status) {
      const statusMap = {
        'pending_admin_approval': '⏳ Pending Admin',
        'pending_coach_approval': '⏳ Pending Coach',
        'confirmed': '✅ Confirmed',
        'completed': '✔️ Completed',
        'cancelled': '❌ Cancelled',
        'pending': '⏳ Pending'
      };
      return statusMap[status] || status.toUpperCase();
    }

    // Display bookings
    function displayBookings(bookings) {
      const container = document.getElementById('bookingsTableContainer');

      if (bookings.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-calendar-times"></i>
            <p>No bookings found matching your filters.</p>
          </div>
        `;
        return;
      }

      const tableHtml = `
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>Coach</th>
              <th>Member</th>
              <th>Session Type</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${bookings.map(booking => `
              <tr>
                <td>${booking.preferredDate || 'N/A'}</td>
                <td>${booking.preferredTime || 'N/A'}</td>
                <td>${booking.coachName || 'N/A'}</td>
                <td>${booking.memberName || 'N/A'}</td>
                <td>${booking.sessionType || 'N/A'}</td>
                <td>
                  <span class="status-badge status-${booking.status || 'pending'}">
                    ${formatStatus(booking.status || 'pending')}
                  </span>
                </td>
                <td>
                  <div class="action-btns">
                    <button class="btn-sm btn-view" onclick="viewBooking('${booking.id}')" title="View Details">
                      <i class="fas fa-eye"></i>
                    </button>
                    ${booking.status === 'pending_admin_approval' ? `
                      <button class="btn-sm btn-confirm" onclick="confirmBooking('${booking.id}')" title="Approve">
                        <i class="fas fa-check"></i> Approve
                      </button>
                    ` : ''}
                    ${booking.status !== 'cancelled' && booking.status !== 'confirmed' && booking.status !== 'completed' ? `
                      <button class="btn-sm btn-cancel" onclick="cancelBooking('${booking.id}')" title="Cancel">
                        <i class="fas fa-times"></i>
                      </button>
                    ` : ''}
                    <button class="btn-sm btn-delete" onclick="deleteBooking('${booking.id}')" title="Delete">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = tableHtml;
    }

    // View booking details
    window.viewBooking = function(id) {
      const booking = allBookings.find(b => b.id === id);
      if (!booking) return;

      const detailsHtml = `
        <div class="detail-row">
          <span class="detail-label">Booking ID:</span>
          <span class="detail-value">${booking.id}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Coach:</span>
          <span class="detail-value">${booking.coachName}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Session Type:</span>
          <span class="detail-value">${booking.sessionType}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Date:</span>
          <span class="detail-value">${booking.preferredDate}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Time:</span>
          <span class="detail-value">${booking.preferredTime}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Member Name:</span>
          <span class="detail-value">${booking.memberName}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Email:</span>
          <span class="detail-value">${booking.memberEmail}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Phone:</span>
          <span class="detail-value">${booking.memberPhone}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Goals:</span>
          <span class="detail-value">${booking.goals || 'N/A'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Experience:</span>
          <span class="detail-value">${booking.experience || 'N/A'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Status:</span>
          <span class="detail-value">
            <span class="status-badge status-${booking.status || 'pending'}">
              ${(booking.status || 'pending').toUpperCase()}
            </span>
          </span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Booking Date:</span>
          <span class="detail-value">${new Date(booking.bookingDate || booking.createdAt).toLocaleString()}</span>
        </div>
      `;

      document.getElementById('bookingDetails').innerHTML = detailsHtml;
      document.getElementById('detailsModal').classList.add('active');
    };

    // Confirm booking (Admin approval - Stage 2)
    window.confirmBooking = async function(id) {
      if (!confirm('Approve this booking? It will be sent to the coach for final confirmation.')) return;

      try {
        // Get booking details first
        const bookingSnapshot = await get(ref(db, `coachBookings/${id}`));
        const booking = bookingSnapshot.val();
        
        if (!booking) {
          alert('Booking not found!');
          return;
        }
        
        // Update booking status to pending_coach_approval (Stage 2)
        const updateData = { 
          status: 'pending_coach_approval',
          workflowStage: 'coach_review',
          adminApprovedAt: Date.now(),
          updatedAt: Date.now()
        };
        
        // Add admin ID if available
        if (auth.currentUser) {
          updateData.adminApprovedBy = auth.currentUser.uid;
        }
        
        await update(ref(db, `coachBookings/${id}`), updateData);
        
        // Notify member
        if (booking.memberId) {
          const memberNotifRef = push(ref(db, `notifications/${booking.memberId}`));
          await set(memberNotifRef, {
            type: 'booking_admin_approved',
            message: `Admin approved your booking with ${booking.coachName}. Waiting for coach confirmation.`,
            data: { bookingId: id },
            read: false,
            createdAt: Date.now()
          });
        }
        
        // Send notification to coach (Stage 2: Coach needs to accept/reschedule)
        if (booking && booking.coachId) {
          const notifRef = push(ref(db, `notifications/${booking.coachId}`));
          await set(notifRef, {
            type: 'booking_pending_approval',
            message: `New booking request: ${booking.memberName} on ${booking.preferredDate} at ${booking.preferredTime} - Please accept or reschedule`,
            bookingId: id,
            read: false,
            createdAt: Date.now()
          });
        }
        
        alert('Booking approved! Coach will now review and accept or reschedule.');
        loadBookings();
      } catch (error) {
        console.error('Error confirming booking:', error);
        alert('Failed to confirm booking. Please try again.');
      }
    };

    // Cancel booking
    window.cancelBooking = async function(id) {
      if (!confirm('Cancel this booking?')) return;

      try {
        await update(ref(db, `coachBookings/${id}`), { status: 'cancelled' });
        alert('Booking cancelled successfully!');
        loadBookings();
      } catch (error) {
        console.error('Error cancelling booking:', error);
        alert('Failed to cancel booking. Please try again.');
      }
    };

    // Delete booking
    window.deleteBooking = async function(id) {
      if (!confirm('Are you sure you want to permanently delete this booking? This cannot be undone.')) return;

      try {
        await remove(ref(db, `coachBookings/${id}`));
        alert('Booking deleted successfully!');
        loadBookings();
      } catch (error) {
        console.error('Error deleting booking:', error);
        alert('Failed to delete booking. Please try again.');
      }
    };

    // Close modal
    window.closeModal = function() {
      document.getElementById('detailsModal').classList.remove('active');
    };

    // Export to CSV
    document.getElementById('exportBtn').addEventListener('click', () => {
      if (filteredBookings.length === 0) {
        alert('No bookings to export!');
        return;
      }

      const csv = [
        ['Date', 'Time', 'Coach', 'Member Name', 'Email', 'Phone', 'Session Type', 'Status', 'Goals'].join(','),
        ...filteredBookings.map(b => [
          b.preferredDate,
          b.preferredTime,
          b.coachName,
          b.memberName,
          b.memberEmail,
          b.memberPhone,
          b.sessionType,
          b.status || 'pending',
          (b.goals || '').replace(/,/g, ';')
        ].join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `coach-bookings-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    });

    // Event listeners
    document.getElementById('filterStatus').addEventListener('change', applyFilters);
    document.getElementById('filterCoach').addEventListener('change', applyFilters);
    document.getElementById('filterDateFrom').addEventListener('change', applyFilters);
    document.getElementById('filterDateTo').addEventListener('change', applyFilters);
    document.getElementById('clearFilters').addEventListener('click', () => {
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterCoach').value = '';
      document.getElementById('filterDateFrom').value = '';
      document.getElementById('filterDateTo').value = '';
      applyFilters();
    });
    document.getElementById('refreshBtn').addEventListener('click', loadBookings);

    // Initial load
    loadBookings();
  </script>
</body>
</html>

