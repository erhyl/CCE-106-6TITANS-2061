<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Admin Role - 6Titans</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #fff;
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: #ffd700;
            text-align: center;
        }
        .card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-family: monospace;
        }
        .status.loading {
            background: #2a2a2a;
            color: #ffd700;
        }
        .status.success {
            background: #1a3a1a;
            color: #4caf50;
            border-left: 4px solid #4caf50;
        }
        .status.error {
            background: #3a1a1a;
            color: #ff6b6b;
            border-left: 4px solid #ff6b6b;
        }
        .status.warning {
            background: #3a3a1a;
            color: #ffa726;
            border-left: 4px solid #ffa726;
        }
        .btn {
            background: #ffd700;
            color: #0a0a0a;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin: 0.5rem;
            font-size: 1rem;
        }
        .btn:hover {
            background: #ffed4e;
        }
        .btn-danger {
            background: #ff6b6b;
            color: #fff;
        }
        .btn-danger:hover {
            background: #ff5252;
        }
        pre {
            background: #0a0a0a;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #333;
        }
        .actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            border-bottom: 1px solid #333;
        }
        .info-label {
            color: #ffd700;
            font-weight: 600;
        }
        .info-value {
            color: #fff;
        }
    </style>
</head>
<body>
    <h1>üîç Admin Role Debugger</h1>
    
    <div class="card">
        <h2>Current User Status</h2>
        <div id="authStatus" class="status loading">‚è≥ Checking authentication...</div>
        <div id="userInfo"></div>
    </div>

    <div class="card">
        <h2>Database Check</h2>
        <div id="firestoreStatus" class="status loading">‚è≥ Checking Firestore...</div>
        <div id="firestoreData"></div>
        
        <div id="rtdbStatus" class="status loading">‚è≥ Checking Realtime Database...</div>
        <div id="rtdbData"></div>
    </div>

    <div class="card">
        <h2>üõ†Ô∏è Quick Actions</h2>
        <div class="actions">
            <button class="btn" id="setAdminFirestore">Set Admin (Firestore)</button>
            <button class="btn" id="setAdminRTDB">Set Admin (RTDB)</button>
            <button class="btn" id="setAdminBoth">Set Admin (Both)</button>
            <button class="btn btn-danger" id="logout">Logout</button>
        </div>
    </div>

    <div class="card">
        <h2>üìã Debug Logs</h2>
        <pre id="debugLogs"></pre>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
        import { getDatabase, ref, get, set, update, child } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC2YE5Cn0gbiuQ5sq8lErotl01itq5-hYk",
            authDomain: "titans-8d454.firebaseapp.com",
            projectId: "titans-8d454",
            storageBucket: "titans-8d454.firebasestorage.app",
            messagingSenderId: "537648978979",
            appId: "1:537648978979:web:30eb90af77c7569b7be596",
            measurementId: "G-W1D2R0Q1L1",
            databaseURL: "https://titans-8d454-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        let currentUser = null;
        let logs = [];

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            document.getElementById('debugLogs').textContent = logs.join('\n');
        }

        function showStatus(elementId, message, type) {
            const el = document.getElementById(elementId);
            if (el) {
                el.className = `status ${type}`;
                el.innerHTML = message;
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                showStatus('authStatus', '‚ùå Not logged in', 'error');
                addLog('No user authenticated', 'error');
                
                document.getElementById('userInfo').innerHTML = `
                    <div class="status warning">
                        ‚ö†Ô∏è You need to login first!
                        <div class="actions">
                            <button class="btn" onclick="window.location.href='login.html'">Go to Login</button>
                        </div>
                    </div>
                `;
                return;
            }

            currentUser = user;
            addLog(`User authenticated: ${user.email} (UID: ${user.uid})`, 'success');
            
            showStatus('authStatus', `‚úÖ Logged in as: ${user.email}`, 'success');
            
            document.getElementById('userInfo').innerHTML = `
                <div class="info-row">
                    <span class="info-label">Email:</span>
                    <span class="info-value">${user.email}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">UID:</span>
                    <span class="info-value">${user.uid}</span>
                </div>
            `;

            // Check Firestore
            try {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const accountType = userData.accountType || 'NOT SET';
                    const role = userData.role || 'NOT SET';
                    
                    addLog(`Firestore data found: accountType="${accountType}", role="${role}"`, 'info');
                    
                    const isAdmin = accountType === 'admin' || role === 'admin';
                    
                    showStatus('firestoreStatus', 
                        isAdmin 
                            ? '‚úÖ Firestore: Admin role found!' 
                            : `‚ö†Ô∏è Firestore: Not admin (accountType="${accountType}", role="${role}")`,
                        isAdmin ? 'success' : 'warning'
                    );
                    
                    document.getElementById('firestoreData').innerHTML = `
                        <pre>${JSON.stringify(userData, null, 2)}</pre>
                    `;
                } else {
                    addLog('User NOT found in Firestore', 'warning');
                    showStatus('firestoreStatus', '‚ö†Ô∏è User not found in Firestore', 'warning');
                    document.getElementById('firestoreData').innerHTML = `
                        <div class="status warning">No data found in Firestore</div>
                    `;
                }
            } catch (error) {
                addLog(`Firestore error: ${error.message}`, 'error');
                showStatus('firestoreStatus', `‚ùå Firestore Error: ${error.message}`, 'error');
            }

            // Check RTDB
            try {
                const snapshot = await get(child(ref(rtdb), `users/${user.uid}`));
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    const accountType = userData.accountType || 'NOT SET';
                    const role = userData.role || 'NOT SET';
                    
                    addLog(`RTDB data found: accountType="${accountType}", role="${role}"`, 'info');
                    
                    const isAdmin = accountType === 'admin' || role === 'admin';
                    
                    showStatus('rtdbStatus', 
                        isAdmin 
                            ? '‚úÖ RTDB: Admin role found!' 
                            : `‚ö†Ô∏è RTDB: Not admin (accountType="${accountType}", role="${role}")`,
                        isAdmin ? 'success' : 'warning'
                    );
                    
                    document.getElementById('rtdbData').innerHTML = `
                        <pre>${JSON.stringify(userData, null, 2)}</pre>
                    `;
                } else {
                    addLog('User NOT found in RTDB', 'warning');
                    showStatus('rtdbStatus', '‚ö†Ô∏è User not found in RTDB', 'warning');
                    document.getElementById('rtdbData').innerHTML = `
                        <div class="status warning">No data found in Realtime Database</div>
                    `;
                }
            } catch (error) {
                addLog(`RTDB error: ${error.message}`, 'error');
                showStatus('rtdbStatus', `‚ùå RTDB Error: ${error.message}`, 'error');
            }
        });

        // Set admin in Firestore
        document.getElementById('setAdminFirestore').addEventListener('click', async () => {
            if (!currentUser) {
                alert('Please login first!');
                return;
            }

            if (!confirm(`Set admin role in Firestore for ${currentUser.email}?`)) return;

            try {
                addLog('Setting admin role in Firestore...', 'info');
                
                const userDoc = await getDoc(doc(db, "users", currentUser.uid));
                
                if (userDoc.exists()) {
                    await updateDoc(doc(db, "users", currentUser.uid), {
                        accountType: "admin",
                        role: "admin"
                    });
                } else {
                    await setDoc(doc(db, "users", currentUser.uid), {
                        uid: currentUser.uid,
                        email: currentUser.email,
                        accountType: "admin",
                        role: "admin",
                        createdAt: new Date().toISOString()
                    });
                }
                
                addLog('‚úÖ Admin role set in Firestore!', 'success');
                alert('‚úÖ Admin role set in Firestore! Refreshing page...');
                location.reload();
            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
                alert(`Error: ${error.message}`);
            }
        });

        // Set admin in RTDB
        document.getElementById('setAdminRTDB').addEventListener('click', async () => {
            if (!currentUser) {
                alert('Please login first!');
                return;
            }

            if (!confirm(`Set admin role in RTDB for ${currentUser.email}?`)) return;

            try {
                addLog('Setting admin role in RTDB...', 'info');
                
                await update(ref(rtdb, `users/${currentUser.uid}`), {
                    accountType: "admin",
                    role: "admin"
                });
                
                addLog('‚úÖ Admin role set in RTDB!', 'success');
                alert('‚úÖ Admin role set in RTDB! Refreshing page...');
                location.reload();
            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
                alert(`Error: ${error.message}`);
            }
        });

        // Set admin in both
        document.getElementById('setAdminBoth').addEventListener('click', async () => {
            if (!currentUser) {
                alert('Please login first!');
                return;
            }

            if (!confirm(`Set admin role in BOTH databases for ${currentUser.email}?`)) return;

            try {
                addLog('Setting admin role in both databases...', 'info');
                
                // Firestore
                const userDoc = await getDoc(doc(db, "users", currentUser.uid));
                if (userDoc.exists()) {
                    await updateDoc(doc(db, "users", currentUser.uid), {
                        accountType: "admin",
                        role: "admin"
                    });
                } else {
                    await setDoc(doc(db, "users", currentUser.uid), {
                        uid: currentUser.uid,
                        email: currentUser.email,
                        accountType: "admin",
                        role: "admin",
                        createdAt: new Date().toISOString()
                    });
                }
                addLog('‚úÖ Firestore updated', 'success');
                
                // RTDB
                await update(ref(rtdb, `users/${currentUser.uid}`), {
                    accountType: "admin",
                    role: "admin"
                });
                addLog('‚úÖ RTDB updated', 'success');
                
                alert('‚úÖ Admin role set in BOTH databases! Refreshing page...');
                location.reload();
            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
                alert(`Error: ${error.message}`);
            }
        });

        // Logout
        document.getElementById('logout').addEventListener('click', async () => {
            if (confirm('Logout?')) {
                try {
                    await signOut(auth);
                    window.location.href = 'login.html';
                } catch (error) {
                    alert(`Logout error: ${error.message}`);
                }
            }
        });
    </script>
</body>
</html>

