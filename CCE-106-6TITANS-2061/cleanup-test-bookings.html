<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cleanup Test Bookings - 6Titans Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #ffffff;
            padding: 2rem;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #ffd700;
            font-size: 2.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #cccccc;
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-card h3 {
            color: #ffd700;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            color: #cccccc;
            font-size: 0.9rem;
        }

        .filter-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .filter-section h2 {
            color: #ffd700;
            margin-bottom: 1rem;
        }

        .filter-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #ffd700;
            cursor: pointer;
        }

        .filter-option label {
            color: #ffffff;
            cursor: pointer;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #ffd700;
            color: #000;
        }

        .btn-primary:hover {
            background: #ffed4e;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #f44336;
            color: #fff;
        }

        .btn-danger:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #4caf50;
            color: #fff;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .bookings-table {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #333;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: rgba(255, 215, 0, 0.1);
        }

        th {
            color: #ffd700;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid #333;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #333;
            color: #ffffff;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .test-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .test-yes {
            background: #ff9800;
            color: #000;
        }

        .test-no {
            background: #4caf50;
            color: #fff;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-completed {
            background: #4caf50;
            color: #fff;
        }

        .status-cancelled {
            background: #f44336;
            color: #fff;
        }

        .status-pending {
            background: #ff9800;
            color: #fff;
        }

        .status-confirmed {
            background: #2196f3;
            color: #fff;
        }

        .delete-btn {
            background: #f44336;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .delete-btn:hover {
            background: #d32f2f;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #ffd700;
            font-size: 1.2rem;
        }

        .spinner {
            border: 4px solid rgba(255, 215, 0, 0.1);
            border-left-color: #ffd700;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid;
        }

        .alert-info {
            background: rgba(33, 150, 243, 0.1);
            border-left-color: #2196f3;
            color: #64b5f6;
        }

        .alert-success {
            background: rgba(76, 175, 80, 0.1);
            border-left-color: #4caf50;
            color: #81c784;
        }

        .alert-warning {
            background: rgba(255, 152, 0, 0.1);
            border-left-color: #ff9800;
            color: #ffb74d;
        }

        .alert-danger {
            background: rgba(244, 67, 54, 0.1);
            border-left-color: #f44336;
            color: #e57373;
        }

        .checkbox-cell {
            text-align: center;
        }

        .checkbox-cell input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #ffd700;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ Cleanup Test Bookings</h1>
        <p class="subtitle">Find and remove test bookings from your Firebase database</p>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3 id="totalBookings">--</h3>
                <p>Total Bookings</p>
            </div>
            <div class="stat-card">
                <h3 id="testBookings">--</h3>
                <p>Test Bookings</p>
            </div>
            <div class="stat-card">
                <h3 id="realBookings">--</h3>
                <p>Real Bookings</p>
            </div>
            <div class="stat-card">
                <h3 id="selectedCount">0</h3>
                <p>Selected for Deletion</p>
            </div>
        </div>

        <div class="filter-section">
            <h2>üîç Test Booking Detection Criteria</h2>
            <div class="filter-options">
                <div class="filter-option">
                    <input type="checkbox" id="filterTestEmail" checked>
                    <label for="filterTestEmail">Contains "test" in email</label>
                </div>
                <div class="filter-option">
                    <input type="checkbox" id="filterTestName" checked>
                    <label for="filterTestName">Contains "test" in user name</label>
                </div>
                <div class="filter-option">
                    <input type="checkbox" id="filterTestCoach" checked>
                    <label for="filterTestCoach">Contains "test" in coach name</label>
                </div>
                <div class="filter-option">
                    <input type="checkbox" id="filterOldBookings">
                    <label for="filterOldBookings">Older than 30 days</label>
                </div>
            </div>
            <button class="btn btn-primary" onclick="scanBookings()">
                <span>üîÑ</span>
                <span>Rescan with Filters</span>
            </button>
        </div>

        <div class="action-buttons">
            <button class="btn btn-primary" onclick="selectAllTest()">
                <span>‚òëÔ∏è</span>
                <span>Select All Test Bookings</span>
            </button>
            <button class="btn btn-primary" onclick="deselectAll()">
                <span>‚¨ú</span>
                <span>Deselect All</span>
            </button>
            <button class="btn btn-danger" id="deleteBtn" onclick="deleteSelected()" disabled>
                <span>üóëÔ∏è</span>
                <span>Delete Selected (0)</span>
            </button>
        </div>

        <div id="alertContainer"></div>

        <div class="bookings-table">
            <div id="loadingIndicator" class="loading">
                <div class="spinner"></div>
                <p>Loading bookings from Firebase...</p>
            </div>
            <table id="bookingsTable" style="display: none;">
                <thead>
                    <tr>
                        <th class="checkbox-cell">
                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleAll(this)">
                        </th>
                        <th>Booking ID</th>
                        <th>User</th>
                        <th>Coach</th>
                        <th>Date/Time</th>
                        <th>Status</th>
                        <th>Is Test?</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="bookingsBody">
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js';
        import { getDatabase, ref, get, remove } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCVQEb64sYACt-_f8qmU0ujbMaKC85hczY",
            authDomain: "titans-8d454.firebaseapp.com",
            databaseURL: "https://titans-8d454-default-rtdb.firebaseio.com",
            projectId: "titans-8d454",
            storageBucket: "titans-8d454.firebasestorage.app",
            messagingSenderId: "1039329092913",
            appId: "1:1039329092913:web:03bc89e68f71ab55dd5c30",
            measurementId: "G-7Z0RPDH1VZ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let allBookings = [];
        let selectedBookings = new Set();

        // Load bookings on page load
        window.addEventListener('DOMContentLoaded', () => {
            scanBookings();
        });

        async function scanBookings() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const bookingsTable = document.getElementById('bookingsTable');
            
            loadingIndicator.style.display = 'block';
            bookingsTable.style.display = 'none';

            try {
                const bookingsRef = ref(db, 'bookings');
                const snapshot = await get(bookingsRef);

                if (!snapshot.exists()) {
                    showAlert('No bookings found in the database.', 'info');
                    loadingIndicator.style.display = 'none';
                    return;
                }

                const bookingsData = snapshot.val();
                allBookings = [];

                // Get filter settings
                const filterTestEmail = document.getElementById('filterTestEmail').checked;
                const filterTestName = document.getElementById('filterTestName').checked;
                const filterTestCoach = document.getElementById('filterTestCoach').checked;
                const filterOldBookings = document.getElementById('filterOldBookings').checked;

                // Get users data for additional info
                const usersRef = ref(db, 'users');
                const usersSnapshot = await get(usersRef);
                const usersData = usersSnapshot.exists() ? usersSnapshot.val() : {};

                for (const [bookingId, booking] of Object.entries(bookingsData)) {
                    const user = usersData[booking.userId] || {};
                    const coach = usersData[booking.coachId] || {};

                    const bookingObj = {
                        id: bookingId,
                        ...booking,
                        userName: user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : (user.email || 'Unknown User'),
                        userEmail: user.email || '',
                        coachName: coach.firstName && coach.lastName ? `${coach.firstName} ${coach.lastName}` : (coach.email || 'Unknown Coach'),
                        coachEmail: coach.email || ''
                    };

                    // Determine if it's a test booking
                    bookingObj.isTest = isTestBooking(bookingObj, {
                        filterTestEmail,
                        filterTestName,
                        filterTestCoach,
                        filterOldBookings
                    });

                    allBookings.push(bookingObj);
                }

                renderBookings();
                updateStats();
                loadingIndicator.style.display = 'none';
                bookingsTable.style.display = 'table';

            } catch (error) {
                console.error('Error loading bookings:', error);
                showAlert('Error loading bookings: ' + error.message, 'danger');
                loadingIndicator.style.display = 'none';
            }
        }

        function isTestBooking(booking, filters) {
            const userEmail = (booking.userEmail || '').toLowerCase();
            const userName = (booking.userName || '').toLowerCase();
            const coachName = (booking.coachName || '').toLowerCase();
            const coachEmail = (booking.coachEmail || '').toLowerCase();

            let isTest = false;

            // Check email
            if (filters.filterTestEmail && (userEmail.includes('test') || userEmail.includes('demo') || userEmail.includes('sample'))) {
                isTest = true;
            }

            // Check user name
            if (filters.filterTestName && (userName.includes('test') || userName.includes('demo') || userName.includes('sample'))) {
                isTest = true;
            }

            // Check coach name
            if (filters.filterTestCoach && (coachName.includes('test') || coachEmail.includes('test') || coachName.includes('demo'))) {
                isTest = true;
            }

            // Check if old
            if (filters.filterOldBookings && booking.createdAt) {
                const bookingDate = new Date(booking.createdAt);
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                if (bookingDate < thirtyDaysAgo) {
                    isTest = true;
                }
            }

            return isTest;
        }

        function renderBookings() {
            const tbody = document.getElementById('bookingsBody');
            tbody.innerHTML = '';

            allBookings.forEach(booking => {
                const row = document.createElement('tr');
                
                const formatDate = (dateStr) => {
                    if (!dateStr) return 'N/A';
                    const date = new Date(dateStr);
                    return date.toLocaleString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };

                const status = (booking.status || 'pending').toLowerCase();
                const statusClass = `status-${status}`;

                row.innerHTML = `
                    <td class="checkbox-cell">
                        <input type="checkbox" class="booking-checkbox" data-id="${booking.id}" onchange="updateSelection()">
                    </td>
                    <td>${booking.id.substring(0, 12)}...</td>
                    <td>
                        <div>${booking.userName}</div>
                        <div style="font-size: 0.8rem; color: #888;">${booking.userEmail}</div>
                    </td>
                    <td>
                        <div>${booking.coachName}</div>
                        <div style="font-size: 0.8rem; color: #888;">${booking.coachEmail}</div>
                    </td>
                    <td>${formatDate(booking.date || booking.createdAt)}</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                    <td>
                        <span class="test-indicator ${booking.isTest ? 'test-yes' : 'test-no'}">
                            ${booking.isTest ? 'TEST' : 'REAL'}
                        </span>
                    </td>
                    <td>
                        <button class="delete-btn" onclick="deleteSingle('${booking.id}')">Delete</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function updateStats() {
            const total = allBookings.length;
            const test = allBookings.filter(b => b.isTest).length;
            const real = total - test;

            document.getElementById('totalBookings').textContent = total;
            document.getElementById('testBookings').textContent = test;
            document.getElementById('realBookings').textContent = real;
        }

        window.updateSelection = function() {
            selectedBookings.clear();
            document.querySelectorAll('.booking-checkbox:checked').forEach(checkbox => {
                selectedBookings.add(checkbox.dataset.id);
            });

            const count = selectedBookings.size;
            document.getElementById('selectedCount').textContent = count;
            
            const deleteBtn = document.getElementById('deleteBtn');
            deleteBtn.disabled = count === 0;
            deleteBtn.innerHTML = `<span>üóëÔ∏è</span><span>Delete Selected (${count})</span>`;
        };

        window.toggleAll = function(checkbox) {
            document.querySelectorAll('.booking-checkbox').forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateSelection();
        };

        window.selectAllTest = function() {
            document.querySelectorAll('.booking-checkbox').forEach((checkbox, index) => {
                const booking = allBookings[index];
                checkbox.checked = booking && booking.isTest;
            });
            updateSelection();
        };

        window.deselectAll = function() {
            document.querySelectorAll('.booking-checkbox').forEach(cb => {
                cb.checked = false;
            });
            document.getElementById('selectAllCheckbox').checked = false;
            updateSelection();
        };

        window.deleteSingle = async function(bookingId) {
            if (!confirm('Are you sure you want to delete this booking?')) {
                return;
            }

            try {
                const bookingRef = ref(db, `bookings/${bookingId}`);
                await remove(bookingRef);
                showAlert('Booking deleted successfully!', 'success');
                scanBookings();
            } catch (error) {
                console.error('Error deleting booking:', error);
                showAlert('Error deleting booking: ' + error.message, 'danger');
            }
        };

        window.deleteSelected = async function() {
            if (selectedBookings.size === 0) {
                return;
            }

            const count = selectedBookings.size;
            if (!confirm(`Are you sure you want to delete ${count} booking(s)? This action cannot be undone.`)) {
                return;
            }

            const deleteBtn = document.getElementById('deleteBtn');
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<span>‚è≥</span><span>Deleting...</span>';

            let successCount = 0;
            let errorCount = 0;

            for (const bookingId of selectedBookings) {
                try {
                    const bookingRef = ref(db, `bookings/${bookingId}`);
                    await remove(bookingRef);
                    successCount++;
                } catch (error) {
                    console.error(`Error deleting booking ${bookingId}:`, error);
                    errorCount++;
                }
            }

            showAlert(`Deleted ${successCount} booking(s) successfully! ${errorCount > 0 ? `Failed: ${errorCount}` : ''}`, successCount > 0 ? 'success' : 'danger');
            
            selectedBookings.clear();
            scanBookings();
        };

        window.scanBookings = scanBookings;

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    </script>
</body>
</html>

