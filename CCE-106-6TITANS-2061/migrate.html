<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Firestore → RTDB Migration</title>
</head>
<body style="background:#111;color:#ffd700;font-family:sans-serif">
  <h2>Firestore → RTDB Migration</h2>
  <pre id="log"></pre>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
    import {
      getDatabase, ref, set, update, child
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2YE5Cn0gbiuQ5sq8lErotl01itq5-hYk",
      authDomain: "titans-8d454.firebaseapp.com",
      projectId: "titans-8d454",
      storageBucket: "titans-8d454.firebasestorage.app",
      messagingSenderId: "537648978979",
      appId: "1:537648978979:web:30eb90af77c7569b7be596",
      measurementId: "G-W1D2R0Q1L1",
      databaseURL: "https://titans-8d454-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const fs = getFirestore(app);
    const rtdb = getDatabase(app);
    const logEl = document.getElementById('log');
    const log = (...args) => { console.log(...args); logEl.textContent += args.join(' ') + '\n'; };

    async function migrateCollection(fsPath, rtdbPath, keyField = 'id') {
      log(`Reading Firestore: ${fsPath}`);
      const snap = await getDocs(collection(fs, fsPath));
      let count = 0;
      for (const d of snap.docs) {
        const data = d.data();
        // choose RTDB key
        const key = (data[keyField] || d.id);
        await set(ref(rtdb, `${rtdbPath}/${key}`), {
          ...data,
          id: key
        });
        count++;
        if (count % 25 === 0) log(`...${count} docs migrated for ${fsPath}`);
      }
      log(`Done: ${count} docs → ${rtdbPath}`);
    }

    async function migrateUsers() {
      log("Migrating users → RTDB users/");
      const snap = await getDocs(collection(fs, 'users'));
      let count = 0;
      for (const d of snap.docs) {
        const data = d.data();
        const uid = data.uid || d.id;
        // write user root
        await update(ref(rtdb, `users/${uid}`), {
          ...data,
          uid
        });
        count++;
      }
      log(`Done users: ${count}`);
    }

    async function run() {
      try {
        // 1) users -> users/{uid}
        await migrateUsers();

        // 2) bookings -> bookings/{id}
        await migrateCollection('bookings', 'bookings', 'id');

        // 3) notifications (if in top-level) -> notifications/{userId}/{notifId}
        // If your Firestore has notifications collection with userId field:
        const notifSnap = await getDocs(collection(fs, 'notifications'));
        let n = 0;
        for (const d of notifSnap.docs) {
          const data = d.data();
          const userId = data.userId;
          const notifId = d.id;
          if (!userId) continue;
          await set(ref(rtdb, `notifications/${userId}/${notifId}`), {
            ...data
          });
          n++;
          if (n % 25 === 0) log(`...${n} notifications`);
        }
        log(`Done notifications: ${n}`);

        // 4) events (if in top-level) -> events/{userId}/{eventId}
        const evtSnap = await getDocs(collection(fs, 'events'));
        let e = 0;
        for (const d of evtSnap.docs) {
          const data = d.data();
          const userId = data.userId;
          const eventId = d.id;
          if (!userId) continue;
          await set(ref(rtdb, `events/${userId}/${eventId}`), {
            ...data
          });
          e++;
          if (e % 25 === 0) log(`...${e} events`);
        }
        log(`Done events: ${e}`);

        // 5) classes (if you had them in Firestore)
        await migrateCollection('classes', 'classes', 'id');

        log('Migration complete ✅');
      } catch (err) {
        log('Migration failed:', err.message);
      }
    }

    run();
  </script> 
</body>
</html>