<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      #authButtons {
        visibility: hidden;
      }
    </style>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Choose Your Plan - 6Titans</title>
    <link rel="stylesheet" href="assets/css/styles-base.css" />
    <link rel="stylesheet" href="assets/css/membership.css" />
    <link rel="stylesheet" href="assets/css/auth-nav.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="assets/css/profile.css" />
    <script src="script.js"></script>
    <script src="membership.js"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
      import {
        getDatabase,
        ref,
        get,
        set,
        update,
        child,
        serverTimestamp as rtdbServerTimestamp,
        onValue,
        push,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
      const firebaseConfig = {
        apiKey: "AIzaSyC2YE5Cn0gbiuQ5sq8lErotl01itq5-hYk",
        authDomain: "titans-8d454.firebaseapp.com",
        projectId: "titans-8d454",
        storageBucket: "titans-8d454.firebasestorage.app",
        messagingSenderId: "537648978979",
        appId: "1:537648978979:web:30eb90af77c7569b7be596",
        measurementId: "G-W1D2R0Q1L1",
        databaseURL: "https://titans-8d454-default-rtdb.firebaseio.com",
      };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const rtdb = getDatabase(app);

      // Expose Firebase objects and helpers for other scripts on this page
      window.firebaseAuth = auth;
      window.firebaseRtdb = rtdb;
      window.firebaseRT = {
        ref,
        get,
        set,
        update,
        child,
        rtdbServerTimestamp,
        onValue,
        push,
      };
      function showUserUI(userData) {
        const authButtons = document.getElementById("authButtons");
        const isAdmin =
          userData &&
          (userData.accountType === "admin" || userData.role === "admin");

        if (authButtons) {
          authButtons.style.visibility = "visible";
          authButtons.innerHTML = `
            <div class="profile-dropdown ${
              isAdmin ? "admin-profile" : ""
            }" id="profileDropdown">
              <button class="profile-btn" id="profileBtn">
                <span class="profile-avatar">ðŸ‘¤</span>
                <span id="navUserName">${
                  isAdmin
                    ? "Admin"
                    : userData && userData.firstName
                    ? userData.firstName
                    : "User"
                }</span>
                <i class="fa fa-caret-down"></i>
              </button>
              <div class="profile-menu" id="profileMenu">
                <div class="profile-menu-header">
                  <span id="profileMenuName">${
                    isAdmin
                      ? "Admin"
                      : userData && userData.firstName
                      ? userData.firstName
                      : "User"
                  } ${
            !isAdmin && userData && userData.lastName ? userData.lastName : ""
          }</span><br>
                  <small id="profileMenuEmail">${
                    userData && userData.email
                      ? userData.email
                      : userData && userData.uid
                      ? userData.uid
                      : ""
                  }</small>
                </div>
                <ul class="profile-menu-list">
                  <li>
                    <a href="#" id="openNotif">
                      <i class="fas fa-bell"></i> Notifications
                      <span class="notif-badge" id="notifBadgeDd" style="display:none;background:#ff6b6b;color:#fff;border-radius:999px;padding:2px 8px;font-size:10px;margin-left:8px;">0</span>
                    </a>
                  </li>
                  <li><a href="${
                    isAdmin ? "admin.html" : "user-dashboard.html"
                  }">${isAdmin ? "Admin Panel" : "Dashboard"}</a></li>
                  <li><a href="#" id="profileViewBtn">View Profile</a></li>
                  <li><button id="logoutBtnNav">Logout</button></li>
                </ul>
              </div>
            </div>
          `;
          // Dropdown logic
          const dropdown = document.getElementById("profileDropdown");
          const btn = document.getElementById("profileBtn");
          if (btn && dropdown) {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              dropdown.classList.toggle("open");
            });
            document.addEventListener("click", (e) => {
              if (!dropdown.contains(e.target))
                dropdown.classList.remove("open");
            });
          }

          // Dropdown notifications panel (anchor inside dropdown)
          let notifPanel = document.getElementById("dropdownNotifPanel");
          if (!notifPanel) {
            notifPanel = document.createElement("div");
            notifPanel.id = "dropdownNotifPanel";
            notifPanel.style.position = "absolute";
            notifPanel.style.right = "16px";
            notifPanel.style.top = "72px";
            notifPanel.style.background = "#1a1a1a";
            notifPanel.style.border = "1px solid #333";
            notifPanel.style.borderRadius = "8px";
            notifPanel.style.padding = "10px";
            notifPanel.style.minWidth = "280px";
            notifPanel.style.maxHeight = "50vh";
            notifPanel.style.overflow = "auto";
            notifPanel.style.display = "none";
            notifPanel.style.zIndex = "2200";
            notifPanel.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;"><strong style="color:#ffd700">Notifications</strong><button id="markAllRead" style="background:#2a2a2a;border:1px solid #333;color:#fff;padding:4px 8px;border-radius:6px;cursor:pointer">Mark all read</button></div><div id="notifList" style="display:flex;flex-direction:column;gap:6px;"></div>`;
            document.body.appendChild(notifPanel);
          }
          const openNotif = document.getElementById("openNotif");
          const badgeDd = document.getElementById("notifBadgeDd");
          if (
            openNotif &&
            window.firebaseAuth &&
            window.firebaseRtdb &&
            window.firebaseRT
          ) {
            const { ref, onValue, update } = window.firebaseRT;
            const rtdb = window.firebaseRtdb;
            const userNow = window.firebaseAuth.currentUser;
            let notifCache = {};
            if (userNow) {
              onValue(ref(rtdb, "notifications/" + userNow.uid), (snap) => {
                notifCache = snap.val() || {};
                const unread = Object.values(notifCache).filter(
                  (n) => n && n.read === false
                ).length;
                if (badgeDd) {
                  badgeDd.style.display = unread > 0 ? "inline-block" : "none";
                  badgeDd.textContent = String(unread);
                }
                const list = document.getElementById("notifList");
                if (list) {
                  const entries = Object.entries(notifCache)
                    .slice(-10)
                    .reverse();
                  list.innerHTML = entries
                    .map(
                      ([id, n]) =>
                        `<div style=\"padding:8px;border:1px solid #333;border-radius:6px;color:#ddd;background:${
                          n.read ? "#161616" : "#202020"
                        };\"><div style=\"color:#ffd700;font-weight:600;\">${
                          n.type || "notice"
                        }</div><div>${
                          n.message || ""
                        }</div><small style=\"color:#888;\">${new Date(
                          n.createdAt || Date.now()
                        ).toLocaleString()}</small></div>`
                    )
                    .join("");
                }
              });
            }
            openNotif.addEventListener("click", (e) => {
              e.preventDefault();
              notifPanel.style.display =
                notifPanel.style.display === "none" ? "block" : "none";
            });
            document.addEventListener("click", (e) => {
              if (
                notifPanel.style.display === "block" &&
                !e.target.closest("#openNotif") &&
                !e.target.closest("#dropdownNotifPanel")
              )
                notifPanel.style.display = "none";
            });
            const markAll = document.getElementById("markAllRead");
            if (markAll) {
              markAll.addEventListener("click", async () => {
                try {
                  const updates = {};
                  Object.entries(notifCache).forEach(([id, n]) => {
                    if (n && n.read === false)
                      updates[
                        "notifications/" + userNow.uid + "/" + id + "/read"
                      ] = true;
                  });
                  if (Object.keys(updates).length > 0)
                    await update(ref(rtdb), updates);
                } catch {}
              });
            }
          }
          // Logout logic
          const logoutBtn = document.getElementById("logoutBtnNav");
          if (logoutBtn) {
            logoutBtn.addEventListener("click", async (e) => {
              e.preventDefault();
              try {
                await signOut(auth);
                window.location.href = "index.html";
              } catch (error) {
                alert("Logout failed: " + error.message);
              }
            });
          }
          // Profile modal logic
          const profileViewBtn = document.getElementById("profileViewBtn");
          if (profileViewBtn) {
            profileViewBtn.addEventListener("click", (e) => {
              e.preventDefault();
              showProfileModal(userData);
            });
          }
        }
      }
      function showProfileModal(userData) {
        // Remove existing modal if present
        const oldModal = document.getElementById("profileModal");
        if (oldModal) oldModal.remove();
        const modal = document.createElement("div");
        modal.id = "profileModal";
        modal.style.position = "fixed";
        modal.style.top = "0";
        modal.style.left = "0";
        modal.style.width = "100vw";
        modal.style.height = "100vh";
        modal.style.background = "rgba(0,0,0,0.7)";
        modal.style.display = "flex";
        modal.style.alignItems = "center";
        modal.style.justifyContent = "center";
        modal.style.zIndex = "3000";
        modal.innerHTML = `
          <div style="background:#181818;padding:2.5rem 2rem 2rem 2rem;border-radius:18px;min-width:320px;max-width:95vw;box-shadow:0 8px 32px #0008;position:relative;">
            <button id="closeProfileModal" style="position:absolute;top:1rem;right:1rem;background:none;border:none;font-size:1.5rem;color:#ffd700;cursor:pointer;">&times;</button>
            <div style="display:flex;align-items:center;gap:1.2rem;margin-bottom:1.5rem;">
              <span style="font-size:2.5rem;">ðŸ‘¤</span>
              <div>
                <div style="font-size:1.3rem;font-weight:700;color:#ffd700;">${
                  userData && userData.firstName ? userData.firstName : ""
                } ${
          userData && userData.lastName ? userData.lastName : ""
        }</div>
                <div style="font-size:1rem;color:#fff;">${
                  userData && userData.email ? userData.email : ""
                }</div>
              </div>
            </div>
            <div style="margin-bottom:1.2rem;">
              <strong>Account Type:</strong> <span style="color:#ffd700;">${
                userData && userData.accountType
                  ? userData.accountType
                  : "Member"
              }</span>
            </div>
            <div style="margin-bottom:1.2rem;">
              <strong>UID:</strong> <span style="color:#fff;">${
                userData && userData.uid ? userData.uid : ""
              }</span>
            </div>
            <div style="margin-bottom:1.2rem;">
              <strong>Joined:</strong> <span style="color:#fff;">${
                userData && userData.createdAt
                  ? new Date(
                      userData.createdAt.seconds * 1000
                    ).toLocaleDateString()
                  : "N/A"
              }</span>
            </div>
            <button style="margin-top:1.5rem;padding:0.7rem 1.5rem;background:#ffd700;color:#111;font-weight:700;border:none;border-radius:8px;cursor:pointer;">Edit Profile (Coming Soon)</button>
          </div>
        `;
        document.body.appendChild(modal);
        document.getElementById("closeProfileModal").onclick = () =>
          modal.remove();
        modal.onclick = (e) => {
          if (e.target === modal) modal.remove();
        };
      }
      function showGuestUI() {
        const authButtons = document.getElementById("authButtons");
        if (authButtons) {
          authButtons.style.visibility = "visible";
          authButtons.innerHTML = `
            <a href="login.html" id="loginBtnNav">Login</a>
            <a href="register.html" id="signupBtnNav">Sign Up</a>
          `;
        }
      }
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // Fetch user info from RTDB; seed if missing
          try {
            const snap = await get(child(ref(rtdb), "users/" + user.uid));
            let userData = snap.exists() ? snap.val() : null;
            if (!userData) {
              const minimal = {
                uid: user.uid,
                email: user.email || "",
                firstName:
                  (user.displayName && user.displayName.split(" ")[0]) ||
                  (user.email ? user.email.split("@")[0] : "User"),
                lastName:
                  (user.displayName &&
                    user.displayName.split(" ").slice(1).join(" ")) ||
                  "",
              };
              await set(ref(rtdb, "users/" + user.uid), minimal);
              userData = minimal;
            }
            const merged = {
              ...userData,
              uid: user.uid,
              email: userData.email || user.email || "",
              firstName:
                userData.firstName ||
                (user.displayName
                  ? user.displayName.split(" ")[0]
                  : user.email
                  ? user.email.split("@")[0]
                  : "User"),
              lastName:
                userData.lastName ||
                (user.displayName
                  ? user.displayName.split(" ").slice(1).join(" ")
                  : ""),
            };
            if (
              !userData.email ||
              !userData.firstName ||
              (!userData.lastName && merged.lastName)
            ) {
              try {
                await set(ref(rtdb, "users/" + user.uid), {
                  ...userData,
                  email: merged.email,
                  firstName: merged.firstName,
                  lastName: merged.lastName,
                  uid: user.uid,
                });
              } catch {}
            }
            showUserUI(merged);
          } catch (e) {
            showUserUI({ firstName: "User", email: user.email || "" });
          }
        } else {
          showGuestUI();
        }
      });
    </script>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar">
      <div class="nav-container">
        <div class="nav-logo">
          <img src="images/image 66.png" alt="6Titans Logo" class="logo-icon" />
          <img src="images/image 67.png" alt="6Titans" class="logo-text" />
        </div>
        <ul class="nav-menu">
          <li class="nav-item">
            <a href="index.html" class="nav-link">Home</a>
          </li>
          <li class="nav-item">
            <a href="membership.html" class="nav-link active">Membership</a>
          </li>
          <li class="nav-item">
            <a href="classes.html" class="nav-link">Classes</a>
          </li>
          <li class="nav-item">
            <a href="workouts.html" class="nav-link">Workouts</a>
          </li>
          <li class="nav-item">
            <a href="coaching.html" class="nav-link">Coaching</a>
          </li>
         
          <li class="nav-item">
            <a href="articles.html" class="nav-link">Articles</a>
          </li>
        </ul>
        <div class="auth-buttons" id="authButtons">
          <a href="login.html" id="loginBtnNav">Login</a>
          <a href="register.html" id="signupBtnNav">Sign Up</a>
        </div>
        <div class="hamburger">
          <span class="bar"></span>
          <span class="bar"></span>
          <span class="bar"></span>
        </div>
      </div>
    </nav>

    <!-- Membership Section -->
    <section class="membership">
      <div class="container">
        <h1 class="page-title">Choose Your Plan</h1>

        <!-- Pricing Grid -->
        <div class="pricing-grid">
          <!-- Basic Plan -->
          <div class="pricing-card">
            <h3 class="plan-name">Basic</h3>
            <div class="plan-price">$29<span>/ Month</span></div>
            <ul class="plan-features">
              <li><i class="fas fa-check"></i>Access to gym facilities</li>
              <li><i class="fas fa-check"></i>Basic workout plans</li>
              <li><i class="fas fa-check"></i>Group classes</li>
              <li><i class="fas fa-check"></i>Progress tracking</li>
            </ul>
            <button class="btn btn-primary choose-plan" data-plan="basic">
              Choose plan
            </button>
          </div>

          <!-- Premium Plan -->
          <div class="pricing-card popular">
            <div class="popular-badge">Most popular</div>
            <h3 class="plan-name">Premium</h3>
            <div class="plan-price">$59<span>/ Month</span></div>
            <ul class="plan-features">
              <li><i class="fas fa-check"></i>Everything in Basic</li>
              <li><i class="fas fa-check"></i>Personal trainer sessions</li>
              <li><i class="fas fa-check"></i>Custom meal plans</li>
              <li><i class="fas fa-check"></i>Online coaching</li>
              <li><i class="fas fa-check"></i>Video call sessions</li>
            </ul>
            <button class="btn btn-primary choose-plan" data-plan="premium">
              Choose plan
            </button>
          </div>

          <!-- Elite Plan -->
          <div class="pricing-card">
            <h3 class="plan-name">Elite</h3>
            <div class="plan-price">$99<span>/ Month</span></div>
            <ul class="plan-features">
              <li><i class="fas fa-check"></i>Everything in Premium</li>
              <li><i class="fas fa-check"></i>24/7 coach access</li>
              <li><i class="fas fa-check"></i>Nutrition counseling</li>
              <li><i class="fas fa-check"></i>Priority booking</li>
              <li><i class="fas fa-check"></i>Exclusive workshops</li>
            </ul>
            <button class="btn btn-primary choose-plan" data-plan="elite">
              Choose plan
            </button>
          </div>
        </div>



       
    <!-- Membership Modal -->
    <div id="membershipModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modalTitle">Choose Your Plan</h2>
        <div id="modalContent">
          <!-- Plan details will be populated here -->
        </div>
        <div class="modal-actions">
          <button class="btn btn-secondary" id="closeModal">Cancel</button>
          <button class="btn btn-primary" id="confirmMembership">
            Confirm Membership
          </button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <div class="footer-logo">
              <img
                src="images/image 66.png"
                alt="6Titans Logo"
                class="logo-icon"
              />
              <img src="images/image 67.png" alt="6Titans" class="logo-text" />
            </div>
            <p>Transform your body, transform your life.</p>
          </div>
          <div class="footer-section">
            <h4>Quick Links</h4>
            <ul>
              <li><a href="index.html">Home</a></li>
              <li><a href="membership.html">Membership</a></li>
              <li><a href="classes.html">Classes</a></li>
              <li><a href="workouts.html">Workouts</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h4>Support</h4>
            <ul>
              <li><a href="#">Help Center</a></li>
              <li><a href="#">Contact Us</a></li>
              <li><a href="#">Privacy Policy</a></li>
              <li><a href="#">Terms of Service</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h4>Follow Us</h4>
            <div class="social-links">
              <a href="#"><i class="fab fa-facebook"></i></a>
              <a href="#"><i class="fab fa-instagram"></i></a>
              <a href="#"><i class="fab fa-twitter"></i></a>
              <a href="#"><i class="fab fa-youtube"></i></a>
            </div>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2024 6Titans. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <script type="module">
      // Initialize role guard to protect against pending coaches
      import { initRoleGuard } from "./role-guard.js";
      initRoleGuard({ requireAuth: false }); // Public page but check for pending coaches
    </script>
    <script src="script.js"></script>
    <script src="membership.js"></script>
  </body>
</html>
