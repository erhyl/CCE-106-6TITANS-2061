<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meet Your Coaches - 6Titans</title>
    <link rel="stylesheet" href="assets/css/styles-base.css" />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="stylesheet" href="assets/css/coaching.css" />
    <link rel="stylesheet" href="assets/css/auth-nav.css" />
    <link rel="stylesheet" href="assets/css/profile.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar">
      <div class="nav-container">
        <div class="nav-logo">
          <img src="images/image 66.png" alt="6Titans Logo" class="logo-icon" />
          <img src="images/image 67.png" alt="6Titans" class="logo-text" />
        </div>
        <ul class="nav-menu">
          <li class="nav-item">
            <a href="index.html" class="nav-link">Home</a>
          </li>
          <li class="nav-item">
            <a href="membership.html" class="nav-link">Membership</a>
          </li>
          <li class="nav-item">
            <a href="classes.html" class="nav-link">Classes</a>
          </li>
          <li class="nav-item">
            <a href="workouts.html" class="nav-link">Workouts</a>
          </li>
          <li class="nav-item">
            <a href="coaching.html" class="nav-link active">Coaching</a>
          </li>
          <li class="nav-item">
            <a href="articles.html" class="nav-link">Articles</a>
          </li>
        </ul>
        <div class="auth-buttons" id="authButtons">
          
        </div>
        <div class="hamburger">
          <span class="bar"></span>
          <span class="bar"></span>
          <span class="bar"></span>
        </div>
      </div>
    </nav>

    <!-- Coaching Section -->
    <section class="coaching">
      <div class="container">
        <h1 class="page-title">Meet Your Coaches</h1>

        <!-- Coaches Grid - Dynamically loaded from Firebase -->
        <div class="coaches-grid" id="coachesGrid">
          <p style="color: #888; text-align: center; grid-column: 1 / -1;">Loading coaches...</p>
        </div>
      </div>
    </section>

    <!-- Dynamic Coach Loading Script -->
    <script type="module">
      import { rtdb } from "./firebase-init.js";
      import { ref, get } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

      // Load coaches from Firebase
      async function loadCoaches() {
        const coachesGrid = document.getElementById('coachesGrid');
        
        try {
          const snapshot = await get(ref(rtdb, 'coachProfiles'));
          const coaches = snapshot.val();

          if (!coaches || Object.keys(coaches).length === 0) {
            coachesGrid.innerHTML = '<p style="color: #888; text-align: center; grid-column: 1 / -1;">No coaches available at the moment. Check back soon!</p>';
            return;
          }

          const coachesHtml = Object.entries(coaches).map(([id, coach]) => `
            <div class="coach-card">
              <div class="coach-avatar">
                <i class="fas fa-user"></i>
              </div>
              <h3 class="coach-name">${coach.name}</h3>
              <p class="coach-specialization">${coach.specialization}</p>
              <p class="coach-description">
                ${coach.description}
              </p>
              ${coach.certifications ? `
                <div class="coach-badges">
                  ${coach.certifications.split(',').map(cert => 
                    `<span class="badge">${cert.trim()}</span>`
                  ).join('')}
                </div>
              ` : ''}
              ${coach.rating ? `
                <div class="coach-rating">
                  <div class="stars">
                    ${Array(5).fill(0).map((_, i) => 
                      i < Math.floor(coach.rating) 
                        ? '<i class="fas fa-star"></i>' 
                        : (i < coach.rating ? '<i class="fas fa-star-half-alt"></i>' : '<i class="far fa-star"></i>')
                    ).join('')}
                  </div>
                  <span class="rating-text">${coach.rating} (${coach.reviews || 0} reviews)</span>
                </div>
              ` : ''}
              <button class="btn btn-primary book-session" data-coach="${coach.name}" data-coach-id="${id}">
                Book Session
              </button>
            </div>
          `).join('');

          coachesGrid.innerHTML = coachesHtml;

          // Re-attach book session event listeners
          document.querySelectorAll('.book-session').forEach(btn => {
            btn.addEventListener('click', function() {
              const coachName = this.getAttribute('data-coach');
              const coachId = this.getAttribute('data-coach-id');
              openBookingModal(coachName, coachId);
            });
          });

        } catch (error) {
          console.error('Error loading coaches:', error);
          coachesGrid.innerHTML = '<p style="color: #f44336; text-align: center; grid-column: 1 / -1;">Failed to load coaches. Please refresh the page.</p>';
        }
      }

      // Open booking modal
      async function openBookingModal(coachName, coachId) {
        console.log('Opening modal for:', coachName, coachId);
        const modal = document.getElementById('bookingModal');
        const coachNameInput = document.getElementById('coachName');
        const memberNameInput = document.getElementById('memberName');
        const memberEmailInput = document.getElementById('memberEmail');
        const memberPhoneInput = document.getElementById('memberPhone');
        
        console.log('Modal element:', modal);
        
        if (!modal) {
          console.error('Modal element not found!');
          return;
        }
        
        if (modal && coachNameInput) {
          coachNameInput.value = coachName;
          coachNameInput.setAttribute('data-coach-id', coachId);
          
          // Auto-fill user details if logged in
          try {
            const { getAuth } = await import("https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js");
            const { getFirestore, doc, getDoc } = await import("https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js");
            const { ref: dbRef, get: dbGet, child } = await import("https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js");
            
            const auth = getAuth();
            const user = auth.currentUser;
            
            if (user) {
              // Try to get user data from Firestore first
              const db = getFirestore();
              const userDoc = await getDoc(doc(db, "users", user.uid));
              
              if (userDoc.exists()) {
                const userData = userDoc.data();
                // Auto-fill name and email
                memberNameInput.value = `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || userData.email;
                memberEmailInput.value = userData.email || user.email;
                // Leave phone empty for user to fill
                memberPhoneInput.value = '';
                memberNameInput.readOnly = true;
                memberEmailInput.readOnly = true;
              } else {
                // Fallback to Realtime Database
                const snapshot = await dbGet(child(dbRef(rtdb), `users/${user.uid}`));
                if (snapshot.exists()) {
                  const userData = snapshot.val();
                  memberNameInput.value = `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || userData.email;
                  memberEmailInput.value = userData.email || user.email;
                  memberPhoneInput.value = '';
                  memberNameInput.readOnly = true;
                  memberEmailInput.readOnly = true;
                }
              }
            }
          } catch (error) {
            console.log('Could not auto-fill user data:', error);
            // If error, just open modal without pre-filling
          }
          
          console.log('Adding show class to modal');
          modal.classList.add('show');
          document.body.style.overflow = 'hidden';
          console.log('Modal should now be visible');
        } else {
          console.error('Modal or coachNameInput not found');
        }
      }

      // Expose function globally for coaching.js
      window.openBookingModal = openBookingModal;

      // Load coaches when page loads
      loadCoaches();
    </script>

  

    <!-- Booking Modal -->
    <div id="bookingModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Book Coaching Session</h2>
        <form id="bookingForm">
          <div class="form-group">
            <label for="coachName">Coach</label>
            <input type="text" id="coachName" name="coachName" readonly />
          </div>
          <div class="form-group">
            <label for="sessionType">Session Type *</label>
            <select id="sessionType" name="sessionType" required>
              <option value="">Select session type</option>
              <option value="in-person">In-Person Training</option>
              <option value="video-call">Video Call Session</option>
              <option value="group-class">Group Class</option>
              <option value="nutrition-consultation">
                Nutrition Consultation
              </option>
            </select>
          </div>
          <div class="form-group">
            <label for="preferredDate">Preferred Date *</label>
            <input
              type="date"
              id="preferredDate"
              name="preferredDate"
              required
            />
          </div>
          <div class="form-group">
            <label for="preferredTime">Preferred Time *</label>
            <select id="preferredTime" name="preferredTime" required>
              <option value="">Select time</option>
              <option value="06:00">6:00 AM</option>
              <option value="07:00">7:00 AM</option>
              <option value="08:00">8:00 AM</option>
              <option value="09:00">9:00 AM</option>
              <option value="10:00">10:00 AM</option>
              <option value="11:00">11:00 AM</option>
              <option value="12:00">12:00 PM</option>
              <option value="13:00">1:00 PM</option>
              <option value="14:00">2:00 PM</option>
              <option value="15:00">3:00 PM</option>
              <option value="16:00">4:00 PM</option>
              <option value="17:00">5:00 PM</option>
              <option value="18:00">6:00 PM</option>
              <option value="19:00">7:00 PM</option>
              <option value="20:00">8:00 PM</option>
            </select>
          </div>
          <div class="form-group">
            <label for="memberName">Your Name *</label>
            <input type="text" id="memberName" name="memberName" required />
          </div>
          <div class="form-group">
            <label for="memberEmail">Email *</label>
            <input type="email" id="memberEmail" name="memberEmail" required />
          </div>
          <div class="form-group">
            <label for="memberPhone">Phone Number *</label>
            <input type="tel" id="memberPhone" name="memberPhone" required />
          </div>
          <div class="form-group">
            <label for="goals">Fitness Goals</label>
            <textarea
              id="goals"
              name="goals"
              rows="3"
              placeholder="Tell us about your fitness goals and what you'd like to achieve..."
            ></textarea>
          </div>
          <div class="form-group">
            <label for="experience">Fitness Experience</label>
            <select id="experience" name="experience">
              <option value="">Select experience level</option>
              <option value="beginner">Beginner (0-6 months)</option>
              <option value="intermediate">
                Intermediate (6 months - 2 years)
              </option>
              <option value="advanced">Advanced (2+ years)</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary">Book Session</button>
        </form>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <div class="footer-logo">
              <img
                src="images/image 66.png"
                alt="6Titans Logo"
                class="logo-icon"
              />
              <img src="images/image 67.png" alt="6Titans" class="logo-text" />
            </div>
            <p>Transform your body, transform your life.</p>
          </div>
          <div class="footer-section">
            <h4>Quick Links</h4>
            <ul>
              <li><a href="index.html">Home</a></li>
              <li><a href="membership.html">Membership</a></li>
              <li><a href="classes.html">Classes</a></li>
              <li><a href="workouts.html">Workouts</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h4>Support</h4>
            <ul>
              <li><a href="#">Help Center</a></li>
              <li><a href="#">Contact Us</a></li>
              <li><a href="#">Privacy Policy</a></li>
              <li><a href="#">Terms of Service</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h4>Follow Us</h4>
            <div class="social-links">
              <a href="#"><i class="fab fa-facebook"></i></a>
              <a href="#"><i class="fab fa-instagram"></i></a>
              <a href="#"><i class="fab fa-twitter"></i></a>
              <a href="#"><i class="fab fa-youtube"></i></a>
            </div>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2024 6Titans. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <script type="module">
      // Initialize role guard to protect against pending coaches
      import { initRoleGuard } from "./role-guard.js";
      initRoleGuard({ requireAuth: false }); // Public page but check for pending coaches
    </script>
    <script src="script.js"></script>
    <script src="coaching.js"></script>
    <script type="module">
      import { ref, get, set, child, push } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
      import { auth, rtdb } from "./firebase-init.js";
      import { initAuthState } from "./auth-ui.js";
      
      // Expose for coaching.js
      window.firebaseAuth = auth;
      window.firebaseRtdb = rtdb;
      window.firebaseRT = { ref, get, set, child, push };
      
      // Initialize auth state with membership gating callback
      initAuthState(async (userData) => {
        try {
          if (!userData || !userData.membership || userData.membership.status !== 'active') {
            const container = document.querySelector('.coaching .container');
            const banner = document.createElement('div');
            banner.style.background = '#1a1a1a';
            banner.style.border = '1px solid #333';
            banner.style.borderLeft = '4px solid #ff6b6b';
            banner.style.color = '#fff';
            banner.style.padding = '12px 16px';
            banner.style.borderRadius = '8px';
            banner.style.margin = '1rem 0';
            banner.innerHTML = `Premium feature: Booking requires an active membership. <a href="membership.html" style="color:#ffd700;text-decoration:underline">Upgrade now</a>`;
            if (container) container.insertBefore(banner, container.children[2] || null);
          }
        } catch (err) {
          console.error('Membership check error:', err);
        }
      });
    </script>
  </body>
</html>
